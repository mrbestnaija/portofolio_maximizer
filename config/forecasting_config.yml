# Time Series Forecasting Configuration
# SARIMAX and GARCH models

forecasting:
  enabled: true
  default_forecast_horizon: 30  # Days ahead
  minimum_history_required: 90  # Soft requirement; below this we skip walk-forward metrics
  minimum_history_strict: 30    # Hard minimum; below this we skip forecasting entirely

  # SARIMAX configuration
  sarimax:
    enabled: false  # Phase 7.10: Disabled by default (15x speedup); re-enable with --enable-sarimax
    auto_select_order: true
    max_p: 3  # Phase 7.3: Increased from 2 to capture more complex AR dynamics
    max_d: 1
    max_q: 2
    seasonal_periods: null  # Auto-detect (null) or specify (12=monthly, 4=quarterly)
    max_P: 2
    max_D: 1
    max_Q: 2
    trend: "c"  # Options: 'c' (constant), 't' (trend), 'ct' (both), 'n' (none)
    enforce_stationarity: true
    enforce_invertibility: true

  # GARCH configuration
  garch:
    enabled: true
    p: 1  # ARCH order
    q: 1  # GARCH order
    vol: "GARCH"  # Options: 'GARCH', 'EGARCH', 'GJR-GARCH'
    dist: "normal"  # Options: 'normal', 't', 'skewt'

  # SAMOSSA configuration
  samossa:
    enabled: true
    window_length: 60        # Phase 7.3: Increased from 40 for richer trajectory matrix
    n_components: 8          # Phase 7.3: Increased from 6 for complex patterns (or -1 for auto)
    use_residual_arima: true # Fit ARIMA on residual component
    arima_order: [1, 0, 1]   # ARIMA(p,d,q) order for residual modelling
    seasonal_order: [0, 0, 0, 0] # Seasonal order (P,D,Q,s)
    min_series_length: 120   # Minimum observations required before fit
    max_forecast_steps: 63   # Guardrail for horizon when using standalone SAMOSSA
    reconstruction_method: "diagonal_averaging"  # SSA reconstruction technique

  # MSSA-RL configuration (change-point + RL forecaster)
  mssa_rl:
    enabled: true
    window_length: 30              # Window for mSSA Page matrix
    rank: null                     # Let MSSARLConfig choose rank to hit ~90% variance
    change_point_threshold: 3.5    # Phase 7.3: Increased from 2.5 to reduce false change-points
    q_learning_alpha: 0.3
    q_learning_gamma: 0.85
    q_learning_epsilon: 0.1
    use_gpu: true            # Optional CuPy acceleration; keep false on Tier-1 CPU runs but changed to true to speed up on Tier-2+GPU
    min_series_length: 150   # Minimum observations required before fit
    max_forecast_steps: 30   # Guardrail for horizon when using standalone MSSA-RL

  # Combined forecasting
  combined:
    enabled: true
    use_sarimax_mean: true
    use_garch_volatility: true
    combine_confidence_intervals: true

  # Ensemble orchestration
  ensemble:
    enabled: true
    confidence_scaling: true  # REQUIRED in production
    # NOTE: Setting confidence_scaling=false is RESEARCH-ONLY mode.
    # See Documentation/PRIORITY_ANALYSIS_20260212.md.
    prefer_diversified_candidate: true
    diversity_tolerance: 0.15  # Phase 7.9: lowered from 0.35 to let pure candidates win more often (reduces blend dilution that causes RMSE violations)
    candidate_weights:
      - {sarimax: 0.45, garch: 0.35, samossa: 0.15, mssa_rl: 0.05}
      - {sarimax: 0.40, samossa: 0.30, garch: 0.20, mssa_rl: 0.10}
      - {sarimax: 0.35, samossa: 0.35, garch: 0.20, mssa_rl: 0.10}
      # Additional candidate profiles (retain pure/fallback candidates below).
      - {garch: 0.85, samossa: 0.10, mssa_rl: 0.05}  # GARCH-dominant for liquid tickers
      - {garch: 0.70, samossa: 0.20, mssa_rl: 0.10}  # GARCH-heavy with SSA
      - {garch: 0.60, samossa: 0.25, mssa_rl: 0.15}  # Balanced GARCH blend
      - {samossa: 0.60, mssa_rl: 0.40}                # SSA-dominant
      - {samossa: 0.45, garch: 0.35, mssa_rl: 0.20}  # Balanced SSA
      # Phase 7.9: mssa_rl-dominant blends (addresses audit violations where mssa_rl > ensemble)
      - {mssa_rl: 0.70, garch: 0.30}                  # MSSA-RL led with GARCH vol support
      - {mssa_rl: 0.70, samossa: 0.30}                # MSSA-RL led with SAMoSSA diversity
      # Pure model fallbacks
      - {garch: 1.0}
      - {samossa: 1.0}
      - {mssa_rl: 1.0}
    minimum_component_weight: 0.05  # Align with EnsembleConfig default guardrail

  # Phase 7.5: Regime Detection for Adaptive Model Selection
  regime_detection:
    enabled: true  # Phase 7.9: regime kept ON; A/B test (2026-02-05) showed no >10% PnL lift from disabling.
    lookback_window: 60  # Days to analyze for regime classification (should match forecasting history)

    # Volatility thresholds (annualized)
    vol_threshold_low: 0.15   # Below 15% annual vol = low volatility regime
    vol_threshold_high: 0.25  # Above 25% annual vol = high volatility (lowered from 0.40; Phase 7.10 audit: 90% in catch-all buckets)

    # Trend strength thresholds (0-1 scale, based on R² from linear regression)
    trend_threshold_weak: 0.30    # Below 0.30 = weak/no trend (rangebound)
    trend_threshold_strong: 0.60  # Above 0.60 = strong directional trend

    # Phase 7.9: Regime-specific ensemble candidate weights (GARCH-floor tuning)
    # Constraint: GARCH >= 40% in first candidate to preserve Phase 7.4 RMSE baseline (1.043).
    # With confidence_scaling=false, first candidate always wins -- GARCH floor prevents
    # the +42% RMSE regression seen with SAMOSSA-dominant overrides in Phase 7.5/7.8.
    regime_candidate_weights:
      CRISIS:
        # Defensive: GARCH-led for volatility forecasting, SAMOSSA support
        - {garch: 0.50, samossa: 0.35, mssa_rl: 0.15}
        - {garch: 0.40, samossa: 0.45, mssa_rl: 0.15}
      MODERATE_MIXED:
        # Balanced: GARCH anchor with SAMOSSA/MSSA diversity
        - {garch: 0.45, samossa: 0.35, mssa_rl: 0.20}
        - {garch: 0.55, samossa: 0.30, mssa_rl: 0.15}
      MODERATE_TRENDING:
        # Trend-aware but GARCH-anchored
        - {garch: 0.40, samossa: 0.45, mssa_rl: 0.15}
        - {garch: 0.55, samossa: 0.35, mssa_rl: 0.10}
      HIGH_VOL_TRENDING:
        # High vol: GARCH for vol forecasting, SAMOSSA for pattern decomposition
        - {garch: 0.45, samossa: 0.40, mssa_rl: 0.15}
        - {garch: 0.55, samossa: 0.30, mssa_rl: 0.15}

    # Regime-specific model preferences (optional overrides)
    # If not specified, uses RegimeDetector's built-in recommendations
    # Format: List models in preference order (highest priority first)
    regime_model_preferences:
      LIQUID_RANGEBOUND:
        # Low vol, mean-reverting, stationary → GARCH excels
        preferred_models: ['garch', 'samossa', 'mssa_rl']
        description: "Stable low-volatility markets, GARCH volatility forecasting optimal"

      MODERATE_RANGEBOUND:
        # Low vol, stationary, some trend → Mixed approach
        preferred_models: ['garch', 'samossa', 'mssa_rl']
        description: "Low volatility with some directional bias"

      MODERATE_TRENDING:
        # Medium vol/trend → Trend-following models
        preferred_models: ['samossa', 'garch', 'mssa_rl']
        description: "Clear trend with moderate volatility"

      HIGH_VOL_TRENDING:
        # High vol, strong trend → Advanced pattern recognition
        preferred_models: ['samossa', 'mssa_rl', 'garch']
        description: "Volatile directional moves, complex patterns"

      CRISIS:
        # Extreme volatility (>50% annual) → Defensive, stick to volatility
        preferred_models: ['garch', 'samossa']
        description: "Crisis mode, focus on volatility and simple models"

      MODERATE_MIXED:
        # Fallback for unclear regimes → Balanced ensemble
        preferred_models: ['garch', 'samossa', 'mssa_rl']
        description: "No clear regime, use balanced ensemble"
