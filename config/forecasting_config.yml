# Time Series Forecasting Configuration
# SARIMAX and GARCH models

forecasting:
  enabled: true
  default_forecast_horizon: 30  # Days ahead
  minimum_history_required: 90  # Soft requirement; below this we skip walk-forward metrics
  minimum_history_strict: 30    # Hard minimum; below this we skip forecasting entirely

  # SARIMAX configuration
  sarimax:
    enabled: true
    auto_select_order: true
    max_p: 3  # Phase 7.3: Increased from 2 to capture more complex AR dynamics
    max_d: 1
    max_q: 2
    seasonal_periods: null  # Auto-detect (null) or specify (12=monthly, 4=quarterly)
    max_P: 2
    max_D: 1
    max_Q: 2
    trend: "c"  # Options: 'c' (constant), 't' (trend), 'ct' (both), 'n' (none)
    enforce_stationarity: true
    enforce_invertibility: true

  # GARCH configuration
  garch:
    enabled: true
    p: 1  # ARCH order
    q: 1  # GARCH order
    vol: "GARCH"  # Options: 'GARCH', 'EGARCH', 'GJR-GARCH'
    dist: "normal"  # Options: 'normal', 't', 'skewt'

  # SAMOSSA configuration
  samossa:
    enabled: true
    window_length: 60        # Phase 7.3: Increased from 40 for richer trajectory matrix
    n_components: 8          # Phase 7.3: Increased from 6 for complex patterns (or -1 for auto)
    use_residual_arima: true # Fit ARIMA on residual component
    arima_order: [1, 0, 1]   # ARIMA(p,d,q) order for residual modelling
    seasonal_order: [0, 0, 0, 0] # Seasonal order (P,D,Q,s)
    min_series_length: 120   # Minimum observations required before fit
    max_forecast_steps: 63   # Guardrail for horizon when using standalone SAMOSSA
    reconstruction_method: "diagonal_averaging"  # SSA reconstruction technique

  # MSSA-RL configuration (change-point + RL forecaster)
  mssa_rl:
    enabled: true
    window_length: 30              # Window for mSSA Page matrix
    rank: null                     # Let MSSARLConfig choose rank to hit ~90% variance
    change_point_threshold: 3.5    # Phase 7.3: Increased from 2.5 to reduce false change-points
    q_learning_alpha: 0.3
    q_learning_gamma: 0.85
    q_learning_epsilon: 0.1
    use_gpu: true            # Optional CuPy acceleration; keep false on Tier-1 CPU runs but changed to true to speed up on Tier-2+GPU
    min_series_length: 150   # Minimum observations required before fit
    max_forecast_steps: 30   # Guardrail for horizon when using standalone MSSA-RL

  # Combined forecasting
  combined:
    enabled: true
    use_sarimax_mean: true
    use_garch_volatility: true
    combine_confidence_intervals: true

  # Ensemble orchestration
  ensemble:
    enabled: true
    confidence_scaling: false  # Phase 7.3: Disabled to allow GARCH-dominant candidates (SAMoSSA has inflated confidence from EVR)
    candidate_weights:
      # Phase 7.3 FIX: Add GARCH-dominant weights based on diagnostic findings
      # Diagnostics showed GARCH RMSE 30.64 vs SARIMAX 229.44 (87% better)
      - {garch: 0.85, sarimax: 0.10, samossa: 0.05}  # GARCH-dominant for liquid tickers
      - {garch: 0.70, samossa: 0.20, mssa_rl: 0.10}  # GARCH-heavy with SSA
      - {garch: 0.60, sarimax: 0.25, samossa: 0.15}  # Balanced GARCH blend
      # Original candidates for regimes where GARCH underperforms
      - {sarimax: 0.6, samossa: 0.4}
      - {sarimax: 0.45, samossa: 0.35, mssa_rl: 0.2}
      - {sarimax: 0.5, mssa_rl: 0.5}
      # Pure model fallbacks
      - {garch: 1.0}
      - {samossa: 1.0}
      - {mssa_rl: 1.0}
    minimum_component_weight: 0.05  # Align with EnsembleConfig default guardrail

  # Phase 7.5: Regime Detection for Adaptive Model Selection
  regime_detection:
    enabled: false  # Feature flag: Set to true to enable regime-aware ensemble selection
    lookback_window: 60  # Days to analyze for regime classification (should match forecasting history)

    # Volatility thresholds (annualized)
    vol_threshold_low: 0.15   # Below 15% annual vol = low volatility regime
    vol_threshold_high: 0.30  # Above 30% annual vol = high volatility regime

    # Trend strength thresholds (0-1 scale, based on R² from linear regression)
    trend_threshold_weak: 0.30    # Below 0.30 = weak/no trend (rangebound)
    trend_threshold_strong: 0.60  # Above 0.60 = strong directional trend

    # Regime-specific model preferences (optional overrides)
    # If not specified, uses RegimeDetector's built-in recommendations
    # Format: List models in preference order (highest priority first)
    regime_model_preferences:
      LIQUID_RANGEBOUND:
        # Low vol, mean-reverting, stationary → GARCH excels
        preferred_models: ['garch', 'sarimax', 'samossa']
        description: "Stable low-volatility markets, GARCH volatility forecasting optimal"

      MODERATE_RANGEBOUND:
        # Low vol, stationary, some trend → Mixed approach
        preferred_models: ['garch', 'sarimax', 'samossa']
        description: "Low volatility with some directional bias"

      MODERATE_TRENDING:
        # Medium vol/trend → Trend-following models
        preferred_models: ['samossa', 'garch', 'sarimax']
        description: "Clear trend with moderate volatility"

      HIGH_VOL_TRENDING:
        # High vol, strong trend → Advanced pattern recognition
        preferred_models: ['samossa', 'mssa_rl', 'garch']
        description: "Volatile directional moves, complex patterns"

      CRISIS:
        # Extreme volatility (>50% annual) → Defensive, stick to volatility
        preferred_models: ['garch', 'sarimax']
        description: "Crisis mode, focus on volatility and simple models"

      MODERATE_MIXED:
        # Fallback for unclear regimes → Balanced ensemble
        preferred_models: ['garch', 'samossa', 'sarimax']
        description: "No clear regime, use balanced ensemble"
