# DVC Data Tracking (Logs + Artifacts)

This repo uses **DVC** to keep large/fast-changing artifacts out of Git while still making them reproducible and recoverable (via a remote).

## Goals

- Keep Git history clean (no growing JSONL/DB/WAL/log dumps).
- Store log artifacts off-disk (Google Drive DVC remote) and **recycle locally every month**.
- Make it easy to restore older logs by checking out a commit + `dvc pull`.

## Current Implementation (Now)

### 1) Git no longer tracks live logs

The following are **untracked in Git** (and ignored by `.gitignore`):

- `logs/automation/execution_log.jsonl`
- `logs/automation/signal_routing_overrides.yml`
- `logs/signals/quant_validation.jsonl`

### 2) Logs are tracked via DVC pointers

DVC tracks the log directories and stores their contents via the DVC cache/remote:

- `logs/automation.dvc` tracks `logs/automation/`
- `logs/signals.dvc` tracks `logs/signals/`
- `logs/.gitignore` is generated by DVC to keep Git from re-tracking the directories

### 3) DVC remotes

Repo defaults:

- Default remote: `localstore` (existing local remote for general data)
- Logs remote: `gdrive_logs` (Google Drive folder)

Google Drive folder (share link):

`https://drive.google.com/drive/folders/1VHYgx_YZ6HVJAjtOxVNLBEzkPJZpc2G0?usp=sharing`

DVC remote URL form:

`gdrive://1VHYgx_YZ6HVJAjtOxVNLBEzkPJZpc2G0`

## One-Time Setup

### Install DVC + Google Drive remote support

```bash
python -m pip install "dvc>=3" dvc-gdrive
```

### Configure env vars (local only)

Set in `.env` (template in `.env.template`):

- `DVC_LOGS_GDRIVE_FOLDER_URL`
- `DVC_LOGS_GDRIVE_FOLDER_ID`
- `DVC_LOGS_REMOTE_NAME` (default: `gdrive_logs`)
- `DVC_LOGS_REMOTE_URL` (default: `gdrive://<folder_id>`)

### Authenticate to Google Drive

On first push/pull to the Drive remote, DVC will prompt for authentication and store the token locally (typically in `.dvc/config.local`).

#### WSL note (browser launch)

On WSL, `xdg-open` may not be available. If DVC prints an auth URL but cannot open a browser, run the push with a Windows-browser launcher:

```bash
BROWSER="python scripts/open_url_windows.py" dvc push -r gdrive_logs logs/automation.dvc logs/signals.dvc
```

## Monthly Log Recycling (Operational Runbook)

### End-of-month snapshot (store logs remotely)

From repo root:

```bash
# Snapshot current month logs into DVC
dvc add logs/automation logs/signals

# Track pointer updates in Git
git add logs/automation.dvc logs/signals.dvc logs/.gitignore
git commit -m "Archive monthly logs via DVC (YYYY-MM)"

# Push to Google Drive DVC remote
dvc push -r gdrive_logs
```

### Recycle local logs (start fresh month)

After the push completes, reset the rolling JSONL logs:

```bash
: > logs/automation/execution_log.jsonl
: > logs/signals/quant_validation.jsonl
```

Option A (recommended): **commit the reset** so the working tree matches the latest DVC pointers:

```bash
dvc add logs/automation logs/signals
git add logs/automation.dvc logs/signals.dvc
git commit -m "Reset rolling logs for new month (YYYY-MM)"
dvc push -r gdrive_logs
```

Option B: don’t commit the reset (keeps Git/DVC pointers at the archived month), but you’ll see `dvc status` report changes until the next snapshot.

### Reclaim local space (optional)

If you want to aggressively reclaim disk:

```bash
# Remove unused local cache objects (keeps remote intact).
dvc gc --workspace -f
```

## Restoring an Older Month

```bash
# Checkout the commit that contains the desired log snapshot
git checkout <commit-or-tag>

# Pull tracked artifacts from the remote
dvc pull -r gdrive_logs
```

## Future Improvements (Planned)

- Add a `scripts/archive_logs_to_dvc.py` helper to automate:
  - month boundary detection,
  - DVC snapshot + push,
  - truncation + optional cache GC,
  - and structured retention policies.
- Add CI guardrails to prevent accidentally committing `logs/**` directly to Git again.
