version: '3.8'

services:
  portfolio-maximizer:
    build:
      context: .
      dockerfile: Dockerfile
      target: production
    image: portfolio-maximizer:v4.5
    container_name: portfolio_maximizer_v45
    
    environment:
      # Data source API keys (set in .env file)
      - ALPHA_VANTAGE_API_KEY=${ALPHA_VANTAGE_API_KEY}
      - FINNHUB_API_KEY=${FINNHUB_API_KEY}
      
      # Portfolio configuration
      - PORTFOLIO_ENV=production
      - PORTFOLIO_LOG_LEVEL=INFO
      - PORTFOLIO_CACHE_ENABLED=true
      
      # Python environment
      - PYTHONUNBUFFERED=1
      - PYTHONDONTWRITEBYTECODE=1
    
    volumes:
      # Mount data directories
      - ./data:/app/data
      - ./logs:/app/logs
      - ./config:/app/config
      - ./cache:/app/cache
      
      # Mount scripts for development
      - ./scripts:/app/scripts:ro
      - ./etl:/app/etl:ro
      
    working_dir: /app
    
    # Resource limits
    deploy:
      resources:
        limits:
          cpus: '2'
          memory: 4G
        reservations:
          cpus: '1'
          memory: 2G
    
    # Health check
    healthcheck:
      test: ["CMD", "python", "-c", "import sys; sys.exit(0)"]
      interval: 30s
      timeout: 10s
      retries: 3
      start_period: 40s
    
    # Restart policy
    restart: unless-stopped
    
    # Default command
    command: python scripts/run_etl_pipeline.py --help

  # Development service with additional tools
  portfolio-dev:
    extends: portfolio-maximizer
    image: portfolio-maximizer:v4.5-dev
    container_name: portfolio_maximizer_dev
    
    build:
      target: builder  # Use builder stage with more tools
    
    environment:
      - PORTFOLIO_ENV=development
      - PORTFOLIO_LOG_LEVEL=DEBUG
    
    volumes:
      # Mount entire project for development
      - .:/app
      # Mount host virtual environment for development
      - ./simpleTrader_env:/opt/venv:ro
      
    # Override command for interactive development
    command: /bin/bash
    stdin_open: true
    tty: true

  # Service for running tests
  portfolio-test:
    extends: portfolio-maximizer
    image: portfolio-maximizer:v4.5-test
    container_name: portfolio_maximizer_test
    
    environment:
      - PORTFOLIO_ENV=test
      - PYTEST_CACHE_DIR=/tmp/pytest_cache
    
    volumes:
      - ./tests:/app/tests:ro
      - ./pytest.ini:/app/pytest.ini:ro
      
    command: pytest -v --no-cov

  # Jupyter notebook service for analysis
  portfolio-notebook:
    extends: portfolio-maximizer
    image: portfolio-maximizer:v4.5-notebook
    container_name: portfolio_notebook
    
    ports:
      - "8888:8888"
    
    environment:
      - JUPYTER_ENABLE_LAB=yes
    
    command: >
      bash -c "pip install jupyterlab && 
               jupyter lab --ip=0.0.0.0 --port=8888 --no-browser 
               --allow-root --NotebookApp.token='' 
               --NotebookApp.password=''"

networks:
  default:
    name: portfolio_network

# Volume definitions for data persistence
volumes:
  portfolio_data:
    driver: local
  portfolio_logs:
    driver: local
  portfolio_cache:
    driver: local
